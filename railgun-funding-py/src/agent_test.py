from hexbytes import HexBytes
import agent
from forta_agent import FindingSeverity, create_transaction_event, Web3, get_json_rpc_url
from src.constants import RAILGUN_ADDRESS, WRAPPED_NATIVE_TOKEN_ADDRESSES
from src.web3_mock import Web3Mock, NEW_EOA, OLD_EOA, NEW_CONTRACT
import timeit

w3 = Web3Mock()
real_w3 = Web3(Web3.HTTPProvider(get_json_rpc_url()))

class TestRailgunFundingAgent:

    def test_transfer_to_contract(self):
        agent.initialize()
        # Contract passed in transaction.data
        tx_event = create_transaction_event({
            'transaction': {
                'hash': "0",
                'to': RAILGUN_ADDRESS[1],
                'from': "0x56f879e6586bfacafd5219207a33cae1dace7c58",
                'value': "0",
                'data': '0x28223a77000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020014a9322a777ab89a463a5c90216de0a067e43f0f0b0362de9b07e974e2eec4f2e30a15e5b38dbb7495394bb1501ec33f5ed4bdc255113f76d29b38e472f25b710d85854e17bbed4527cf9afd0bfca9fc3bdc02780fb32bc7fc6bc488e5c6760303ae8578afebbeb6101df91dac1c0b2ef87d2b461abc61c013c90fb2e022ff728ee6ed3e8b7fa4e4562950a734b742d55dae494a462332a2a12ebd4dd23cea4195ae4ec0a927a0e4f68889e9f9a11c263f24e8916033e770952cdeff6f639ed28b585b1986df8ecf44338579e980dd9ac42a6a309d8be33dfe41195df1f374a02e053c39108ab19ba670480af5e8a861449ca22989d119669d5a962e939e72d0d4456a1f6ae76a2abceae8e24e8e45f29edbb285f179053ca5bf2077f09685d0000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038f4aada8cfd659100000000000000000000000000000000000000000000000000000000000000012de1ccfbf73c06c2b70af5096abc8c40e0708fb9bcad43b2e02dec73b663d9be000000000000000000000000000000000000000000000000000000000000000205003c1a43ee3604b91d57b48fbd339260abe9d7bfd3dc788cace83fdaef0fb70538469457c3d13c42432addd50d4c5d1cad7f2f15735bae464412db68307db300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304f7d892000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a19931d28a29c4ec23780d927790aa6f2ca2a847c01fc5651069aa698af12be8600000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000204fc45662482c45e2135f8a9bdbb6acb8d9275c9832864f6db76dcc1edbb5c6c4df790c6d36d9c67c9dda5e00131259eadc5b8b7b4b091b1b7f519879b65ec8c7e28117fbfcef707346c3470873e0edfcfbbe9dfe1797bbccc8e84b494e4355a72f8357b0d74fdbf9cd67826a6bab4f746bf3742699ce71c2e4298186b876805990ab5737b4354ea4da5d7c79a825dbbb377b707feb3e31a41253c5b2e98d54e76e65d07a8c3294d572c64d44a9694dc818c474dd65b71b778622882668f1c0ad00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000003ed7c1f45974f65e950c52d8bcc4b7e5589dbcedb3e5c43996e54c08d90a3aa54710ddc5d8762cac97fae2d9310333d5ce53dcb8fd4b3d9555146bab4169ed00000000000000000000000000000000000000000000000000000000000000000000e70ab8b882c4e89309ad3ba4a5dab1f2aa8e2d75f9e6c8836e438999cbf1eb000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001000000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024d5774a280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e4c2e9ffd80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012d56c1ade01525dbe24c89bba0a726cf3a30c76000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
            },
            'block': {
                'number': 1
            },
            'logs': [{
                'address': WRAPPED_NATIVE_TOKEN_ADDRESSES[1],
                'data': '0x00000000000000000000000000000000000000000000000038d0373a011e0b13',
                'topics':[HexBytes("0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65"),
                          HexBytes("0x0000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a")]
            }]
            
        })

        findings = agent.detect_railgun_funding(w3, tx_event)
        assert len(findings) == 0, "This should have not triggered a finding as the to is a contract"


    def test_not_transfer_from_railgun(self):
        agent.initialize()

        tx_event = create_transaction_event({
            'transaction': {
                'hash': "0",
                'to': NEW_CONTRACT,
                'from': "0x56f879e6586bfacafd5219207a33cae1dace7c58",
                'value': "0",
                'data': '0x28223a77000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020014a9322a777ab89a463a5c90216de0a067e43f0f0b0362de9b07e974e2eec4f2e30a15e5b38dbb7495394bb1501ec33f5ed4bdc255113f76d29b38e472f25b710d85854e17bbed4527cf9afd0bfca9fc3bdc02780fb32bc7fc6bc488e5c6760303ae8578afebbeb6101df91dac1c0b2ef87d2b461abc61c013c90fb2e022ff728ee6ed3e8b7fa4e4562950a734b742d55dae494a462332a2a12ebd4dd23cea4195ae4ec0a927a0e4f68889e9f9a11c263f24e8916033e770952cdeff6f639ed28b585b1986df8ecf44338579e980dd9ac42a6a309d8be33dfe41195df1f374a02e053c39108ab19ba670480af5e8a861449ca22989d119669d5a962e939e72d0d4456a1f6ae76a2abceae8e24e8e45f29edbb285f179053ca5bf2077f09685d0000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038f4aada8cfd659100000000000000000000000000000000000000000000000000000000000000012de1ccfbf73c06c2b70af5096abc8c40e0708fb9bcad43b2e02dec73b663d9be000000000000000000000000000000000000000000000000000000000000000205003c1a43ee3604b91d57b48fbd339260abe9d7bfd3dc788cace83fdaef0fb70538469457c3d13c42432addd50d4c5d1cad7f2f15735bae464412db68307db300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304f7d892000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a19931d28a29c4ec23780d927790aa6f2ca2a847c01fc5651069aa698af12be8600000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000204fc45662482c45e2135f8a9bdbb6acb8d9275c9832864f6db76dcc1edbb5c6c4df790c6d36d9c67c9dda5e00131259eadc5b8b7b4b091b1b7f519879b65ec8c7e28117fbfcef707346c3470873e0edfcfbbe9dfe1797bbccc8e84b494e4355a72f8357b0d74fdbf9cd67826a6bab4f746bf3742699ce71c2e4298186b876805990ab5737b4354ea4da5d7c79a825dbbb377b707feb3e31a41253c5b2e98d54e76e65d07a8c3294d572c64d44a9694dc818c474dd65b71b778622882668f1c0ad00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000003ed7c1f45974f65e950c52d8bcc4b7e5589dbcedb3e5c43996e54c08d90a3aa54710ddc5d8762cac97fae2d9310333d5ce53dcb8fd4b3d9555146bab4169ed00000000000000000000000000000000000000000000000000000000000000000000e70ab8b882c4e89309ad3ba4a5dab1f2aa8e2d75f9e6c8836e438999cbf1eb000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001000000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024d5774a280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e4c2e9ffd80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012d56c1ade01525dbe24c89bba0a726cf3a30c76000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
            },
            'block': {
                'number': 1
            },
            'logs': [{
                'address': WRAPPED_NATIVE_TOKEN_ADDRESSES[1],
                'data': '0x00000000000000000000000000000000000000000000000038d0373a011e0b13',
                'topics':[HexBytes("0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65"),
                          HexBytes("0x0000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a")]
            }]
            
        })

        findings = agent.detect_railgun_funding(w3, tx_event)
        assert len(findings) == 0, "This should have not triggered a finding as the to is not Railgun"


    def test_transfer_from_railgun_to_new_account(self):
        agent.initialize()
        # New EOA passed in transaction.data
        tx_event = create_transaction_event({
            'transaction': {
                'hash': "0",
                'to': RAILGUN_ADDRESS[1],
                'from': "0x56f879e6586bfacafd5219207a33cae1dace7c58",
                'value': "0",
                'data': '0x28223a77000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020014a9322a777ab89a463a5c90216de0a067e43f0f0b0362de9b07e974e2eec4f2e30a15e5b38dbb7495394bb1501ec33f5ed4bdc255113f76d29b38e472f25b710d85854e17bbed4527cf9afd0bfca9fc3bdc02780fb32bc7fc6bc488e5c6760303ae8578afebbeb6101df91dac1c0b2ef87d2b461abc61c013c90fb2e022ff728ee6ed3e8b7fa4e4562950a734b742d55dae494a462332a2a12ebd4dd23cea4195ae4ec0a927a0e4f68889e9f9a11c263f24e8916033e770952cdeff6f639ed28b585b1986df8ecf44338579e980dd9ac42a6a309d8be33dfe41195df1f374a02e053c39108ab19ba670480af5e8a861449ca22989d119669d5a962e939e72d0d4456a1f6ae76a2abceae8e24e8e45f29edbb285f179053ca5bf2077f09685d0000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038f4aada8cfd659100000000000000000000000000000000000000000000000000000000000000012de1ccfbf73c06c2b70af5096abc8c40e0708fb9bcad43b2e02dec73b663d9be000000000000000000000000000000000000000000000000000000000000000205003c1a43ee3604b91d57b48fbd339260abe9d7bfd3dc788cace83fdaef0fb70538469457c3d13c42432addd50d4c5d1cad7f2f15735bae464412db68307db300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304f7d892000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a19931d28a29c4ec23780d927790aa6f2ca2a847c01fc5651069aa698af12be8600000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000204fc45662482c45e2135f8a9bdbb6acb8d9275c9832864f6db76dcc1edbb5c6c4df790c6d36d9c67c9dda5e00131259eadc5b8b7b4b091b1b7f519879b65ec8c7e28117fbfcef707346c3470873e0edfcfbbe9dfe1797bbccc8e84b494e4355a72f8357b0d74fdbf9cd67826a6bab4f746bf3742699ce71c2e4298186b876805990ab5737b4354ea4da5d7c79a825dbbb377b707feb3e31a41253c5b2e98d54e76e65d07a8c3294d572c64d44a9694dc818c474dd65b71b778622882668f1c0ad00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000003ed7c1f45974f65e950c52d8bcc4b7e5589dbcedb3e5c43996e54c08d90a3aa54710ddc5d8762cac97fae2d9310333d5ce53dcb8fd4b3d9555146bab4169ed00000000000000000000000000000000000000000000000000000000000000000000e70ab8b882c4e89309ad3ba4a5dab1f2aa8e2d75f9e6c8836e438999cbf1eb000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001000000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024d5774a280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e4c2e9ffd80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000052d56c1ade01525dbe24c89bba0a726cf3a30c76000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
            },
            'block': {
                'number': 1
            },
            'logs': [{
                'address': WRAPPED_NATIVE_TOKEN_ADDRESSES[1],
                'data': '0x00000000000000000000000000000000000000000000000038d0373a011e0b13',
                'topics':[HexBytes("0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65"),
                          HexBytes("0x0000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a")]
            }]       
        })

        findings = agent.detect_railgun_funding(w3, tx_event)
        assert len(findings) == 1, "This should have triggered a finding"
        assert findings[0].alert_id == "FUNDING-RAILGUN-NEW-ACCOUNT", "This is a tx from Railgun to a new account"
        assert findings[0].severity == FindingSeverity.Low, "Severity should be low"


    def test_low_value_transfer_from_railgun(self):
        agent.initialize()
        # Low value passed in transaction.logs.data
        tx_event = create_transaction_event({
            'transaction': {
                'hash': "0",
                'to': RAILGUN_ADDRESS[1],
                'from': "0x077d360f11d220e4d5d831430c81c26c9be7c4a4",
                'value': "0",
                'data': '0x28223a77000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020014a9322a777ab89a463a5c90216de0a067e43f0f0b0362de9b07e974e2eec4f2e30a15e5b38dbb7495394bb1501ec33f5ed4bdc255113f76d29b38e472f25b710d85854e17bbed4527cf9afd0bfca9fc3bdc02780fb32bc7fc6bc488e5c6760303ae8578afebbeb6101df91dac1c0b2ef87d2b461abc61c013c90fb2e022ff728ee6ed3e8b7fa4e4562950a734b742d55dae494a462332a2a12ebd4dd23cea4195ae4ec0a927a0e4f68889e9f9a11c263f24e8916033e770952cdeff6f639ed28b585b1986df8ecf44338579e980dd9ac42a6a309d8be33dfe41195df1f374a02e053c39108ab19ba670480af5e8a861449ca22989d119669d5a962e939e72d0d4456a1f6ae76a2abceae8e24e8e45f29edbb285f179053ca5bf2077f09685d0000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038f4aada8cfd659100000000000000000000000000000000000000000000000000000000000000012de1ccfbf73c06c2b70af5096abc8c40e0708fb9bcad43b2e02dec73b663d9be000000000000000000000000000000000000000000000000000000000000000205003c1a43ee3604b91d57b48fbd339260abe9d7bfd3dc788cace83fdaef0fb70538469457c3d13c42432addd50d4c5d1cad7f2f15735bae464412db68307db300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304f7d892000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a19931d28a29c4ec23780d927790aa6f2ca2a847c01fc5651069aa698af12be8600000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000204fc45662482c45e2135f8a9bdbb6acb8d9275c9832864f6db76dcc1edbb5c6c4df790c6d36d9c67c9dda5e00131259eadc5b8b7b4b091b1b7f519879b65ec8c7e28117fbfcef707346c3470873e0edfcfbbe9dfe1797bbccc8e84b494e4355a72f8357b0d74fdbf9cd67826a6bab4f746bf3742699ce71c2e4298186b876805990ab5737b4354ea4da5d7c79a825dbbb377b707feb3e31a41253c5b2e98d54e76e65d07a8c3294d572c64d44a9694dc818c474dd65b71b778622882668f1c0ad00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000003ed7c1f45974f65e950c52d8bcc4b7e5589dbcedb3e5c43996e54c08d90a3aa54710ddc5d8762cac97fae2d9310333d5ce53dcb8fd4b3d9555146bab4169ed00000000000000000000000000000000000000000000000000000000000000000000e70ab8b882c4e89309ad3ba4a5dab1f2aa8e2d75f9e6c8836e438999cbf1eb000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001000000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024d5774a280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e4c2e9ffd80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002d56c1ade01525dbe24c89bba0a726cf3a30c76000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'

            },
            'block': {
                'number': 1
            },
            'logs': [{
                'address': WRAPPED_NATIVE_TOKEN_ADDRESSES[1],
                'data': '0x000000000000000000000000000000000000000000000000000000000000001',
                'topics':[HexBytes("0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65"),
                          HexBytes("0x0000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a")]
            }]
        })

        findings = agent.detect_railgun_funding(w3, tx_event)
        assert len(findings) == 1, "This should have triggered a finding"
        assert findings[0].alert_id == "FUNDING-RAILGUN-LOW-AMOUNT", "This is a low value transfer from Railgun"
        assert findings[0].severity == FindingSeverity.Low, "Severity should be low"

    
    def test_high_value_transfer_from_railgun(self):
        agent.initialize()
        # High value passed in transaction.logs.data
        tx_event = create_transaction_event({
            'transaction': {
                'hash': "0",
                'to': RAILGUN_ADDRESS[1],
                'from': "0x077d360f11d220e4d5d831430c81c26c9be7c4a4",
                'value': "0",
                'data': '0x28223a77000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020014a9322a777ab89a463a5c90216de0a067e43f0f0b0362de9b07e974e2eec4f2e30a15e5b38dbb7495394bb1501ec33f5ed4bdc255113f76d29b38e472f25b710d85854e17bbed4527cf9afd0bfca9fc3bdc02780fb32bc7fc6bc488e5c6760303ae8578afebbeb6101df91dac1c0b2ef87d2b461abc61c013c90fb2e022ff728ee6ed3e8b7fa4e4562950a734b742d55dae494a462332a2a12ebd4dd23cea4195ae4ec0a927a0e4f68889e9f9a11c263f24e8916033e770952cdeff6f639ed28b585b1986df8ecf44338579e980dd9ac42a6a309d8be33dfe41195df1f374a02e053c39108ab19ba670480af5e8a861449ca22989d119669d5a962e939e72d0d4456a1f6ae76a2abceae8e24e8e45f29edbb285f179053ca5bf2077f09685d0000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038f4aada8cfd659100000000000000000000000000000000000000000000000000000000000000012de1ccfbf73c06c2b70af5096abc8c40e0708fb9bcad43b2e02dec73b663d9be000000000000000000000000000000000000000000000000000000000000000205003c1a43ee3604b91d57b48fbd339260abe9d7bfd3dc788cace83fdaef0fb70538469457c3d13c42432addd50d4c5d1cad7f2f15735bae464412db68307db300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304f7d892000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a19931d28a29c4ec23780d927790aa6f2ca2a847c01fc5651069aa698af12be8600000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000204fc45662482c45e2135f8a9bdbb6acb8d9275c9832864f6db76dcc1edbb5c6c4df790c6d36d9c67c9dda5e00131259eadc5b8b7b4b091b1b7f519879b65ec8c7e28117fbfcef707346c3470873e0edfcfbbe9dfe1797bbccc8e84b494e4355a72f8357b0d74fdbf9cd67826a6bab4f746bf3742699ce71c2e4298186b876805990ab5737b4354ea4da5d7c79a825dbbb377b707feb3e31a41253c5b2e98d54e76e65d07a8c3294d572c64d44a9694dc818c474dd65b71b778622882668f1c0ad00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000003ed7c1f45974f65e950c52d8bcc4b7e5589dbcedb3e5c43996e54c08d90a3aa54710ddc5d8762cac97fae2d9310333d5ce53dcb8fd4b3d9555146bab4169ed00000000000000000000000000000000000000000000000000000000000000000000e70ab8b882c4e89309ad3ba4a5dab1f2aa8e2d75f9e6c8836e438999cbf1eb000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001000000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024d5774a280000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e4c2e9ffd80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002d56c1ade01525dbe24c89bba0a726cf3a30c76000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'

            },
            'block': {
                'number': 1
            },
            'logs': [{
                'address': WRAPPED_NATIVE_TOKEN_ADDRESSES[1],
                'data': '0x00000000000000000000000000000000000000000000000038d0373a011e0b13',
                'topics':[HexBytes("0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65"),
                          HexBytes("0x0000000000000000000000004025ee6512dbbda97049bcf5aa5d38c54af6be8a")]
            }]
        })

        findings = agent.detect_railgun_funding(w3, tx_event)
        assert len(findings) == 0, "This should not have triggered a finding - It is to an 'old' address and is over the threshold."
